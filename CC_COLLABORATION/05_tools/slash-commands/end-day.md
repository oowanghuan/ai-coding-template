# /end-day - 每日结束工作

你是一个 AI 协作开发助手。用户请求结束今天的工作，需要更新进度、生成总结并提交代码。

## 触发方式

用户可以通过以下方式触发：
- `/end-day` 或 `/end-day <feature>`
- "下班了"
- "结束工作"
- "收工"

## 参数

- `$ARGUMENTS`：可选，功能模块名称（如 `user-auth`）。如未指定，处理所有有变更的功能模块。

## 执行步骤

### 1. 显示提示信息

```
🌙 好的，让我们整理今天的工作。

正在执行下班流程...
```

### 2. 更新 PROGRESS_LOG

读取并更新 `docs/{feature}/90_PROGRESS_LOG.yaml`：

#### 2.1 检查当前任务状态

读取 YAML 文件，找出当前阶段所有任务的状态。

#### 2.2 询问用户完成情况

```
今天的任务进展如何？

当前进行中的任务：
• [CODE-004] 实现登录 API 调用
• [CODE-005] 实现 Token 存储

请告诉我哪些已完成，或者直接说"都完成了"/"没完成"
```

#### 2.3 更新任务状态

根据用户回答，更新 YAML 中的任务状态：
- `status: wip` → `status: done`
- 添加 `completed_at: {current_date}`
- 确保同一时间只有一个任务是 `wip`

#### 2.4 更新断点信息（cc_checkpoint）

```yaml
cc_checkpoint:
  session_id: "cc-{current_date}-{feature}"
  last_file_edited: "{今天最后编辑的文件}"
  last_action: "{今天完成的最后操作}"
  next_step: "{明天第一个要做的事}"
  context_files:
    - "{相关文件1}"
    - "{相关文件2}"
```

#### 2.5 重新计算统计信息

```yaml
stats:
  total_tasks: {count_all_tasks}
  done: {count_done}
  wip: {count_wip}
  pending: {count_pending}
  completion_rate: "{(done/total)*100}%"
```

#### 2.6 更新时间戳

```yaml
meta:
  last_updated: "{current_datetime}"
```

```
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
📊 进度更新
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
今日完成的任务：
• [CODE-004] 实现登录 API 调用 ✅
• [CODE-005] 实现 Token 存储 ✅

进行中的任务：
• [CODE-006] 添加登录状态管理 🔄

已更新: docs/{feature}/90_PROGRESS_LOG.yaml
```

### 3. 生成每日总结

调用 `/daily-summary` 生成今日工作总结：

```
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
📅 每日总结
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
✅ 今日完成: 2 项任务
🔄 进行中: 1 项任务
📈 整体进度: 60% (+15%)

已生成: docs/{feature}/91_DAILY_SUMMARY/{date}.md
```

### 4. 检查 Git 状态

```bash
git status
```

列出所有变更的文件：

```
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
📁 待提交文件
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
修改 (Modified):
• src/auth/login.vue
• src/auth/api.ts
• docs/user-auth/90_PROGRESS_LOG.yaml

新增 (Untracked):
• docs/user-auth/91_DAILY_SUMMARY/2024-12-11.md
```

### 5. 执行 Git Add 和 Commit

```bash
git add .
git commit -m "feat({feature}): {today_summary}

- {completed_task_1}
- {completed_task_2}

进度: {completion_rate}%

🤖 Generated with Claude Code"
```

Commit 消息格式：
- 如果今天主要是新功能：`feat({feature}): {summary}`
- 如果今天主要是修复：`fix({feature}): {summary}`
- 如果今天主要是文档：`docs({feature}): {summary}`
- 如果是多功能：`chore: 每日进度更新`

```
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
💾 Git 提交
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
✅ 已提交: {commit_hash}

提交信息:
feat(user-auth): 完成登录 API 和 Token 存储

- [CODE-004] 实现登录 API 调用
- [CODE-005] 实现 Token 存储

进度: 60%
```

### 6. 确认推送

**重要**：推送需要用户确认！

```
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
📤 准备推送
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
分支: main
远程: origin

是否推送到远程仓库？(y/n)
```

如果用户确认：
```bash
git push origin <branch>
```

### 7. 输出完整摘要

```
🌙 每日结束 - {date}

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
📊 今日成果
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
✅ 完成: 2 项任务
🔄 进行中: 1 项任务
📈 进度提升: +15%

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
📝 生成的文档
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
• docs/{feature}/91_DAILY_SUMMARY/{date}.md
• docs/{feature}/90_PROGRESS_LOG.yaml (更新)

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
💾 Git 状态
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
• 提交: {commit_hash}
• 推送: ✅ 已推送到 origin/main

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
📋 明日计划
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
⏭️ 下一步: {next_step}

待完成任务:
• [CODE-006] 添加登录状态管理
• [CODE-007] 实现自动登录

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

✅ 下班流程完成！辛苦了，明天见！ 👋
```

## 输出示例

```
🌙 每日结束 - 2024-12-11

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
📊 今日成果
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
✅ 完成: 4 项任务
🔄 进行中: 1 项任务
📈 进度提升: +20%

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
📝 生成的文档
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
• docs/user-auth/91_DAILY_SUMMARY/2024-12-11.md
• docs/user-auth/90_PROGRESS_LOG.yaml (更新)

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
💾 Git 状态
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
• 提交: a1b2c3d
• 推送: ✅ 已推送到 origin/main

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
📋 明日计划
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
⏭️ 下一步: 添加登录状态管理

待完成任务:
• [CODE-006] 添加登录状态管理
• [CODE-007] 实现自动登录

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

✅ 下班流程完成！辛苦了，明天见！ 👋
```

## 快速模式

如果用户使用 `/end-day --quick` 或确认使用快速模式：
- 自动使用上次编辑的文件作为 `last_file_edited`
- 自动生成 commit 消息
- 自动推送（无需确认）

## 注意事项

- 如果没有任何变更，提示"今天没有需要提交的变更"
- 如果 git 操作失败，显示错误信息并提供解决建议
- 推送前始终需要用户确认（除非使用 --quick 模式）
- 更新 `cc_checkpoint` 的 `session_id` 为当前 session
- 保留进行中的任务状态，不自动标记为完成

## 关联命令

- `/start-day` - 每日开始工作
- `/daily-summary` - 生成每日总结
- `/iresume` - 断点恢复
- `/check-progress` - 查看进度状态

# 03_MODULE_DECOMPOSITION.md
# {项目名} - 模块划分

> 版本：v0.1
> 架构师：{architect_name}
> 最后更新：{date}
> 状态：Draft

---

## 1. 业务域分析

### 1.1 业务背景

{简要描述业务背景和核心问题}

### 1.2 核心业务流程

```
主业务流程：

用户 ──▶ [入口] ──▶ [核心流程] ──▶ [结果]

详细流程：
┌─────────────────────────────────────────────────────────────┐
│  1. {步骤1}                                                  │
│     │                                                        │
│     ▼                                                        │
│  2. {步骤2}                                                  │
│     │                                                        │
│     ▼                                                        │
│  3. {步骤3}                                                  │
│     │                                                        │
│     ▼                                                        │
│  4. {结果}                                                   │
└─────────────────────────────────────────────────────────────┘
```

### 1.3 业务边界

**系统边界内**：
- {功能1}
- {功能2}
- {功能3}

**系统边界外**（依赖外部系统）：
- {外部系统1}：{交互方式}
- {外部系统2}：{交互方式}

---

## 2. 功能模块列表

> **重要**：此表格是 `/plan-features` 命令的**唯一数据源**，将批量生成 feature 目录。
>
> **字段说明**（全部必填，除非标注可选）：
>
> | 字段 | 格式 | 说明 |
> |------|------|------|
> | `module_id` | `M001` 格式 | 唯一标识，用于依赖引用 |
> | `feature_name` | kebab-case | 将作为 `docs/{feature_name}/` 目录名 |
> | `scope` | 一句话 | 功能范围，注入到 10_CONTEXT |
> | `deliverable` | 逗号分隔 | 交付物类型，决定必需产出物（见下方约束表） |
> | `acceptance` | 一句话 | **可验证结果**（非"完成开发"） |
> | `priority` | P0/P1/P2/P3 | P0=必须, P1=重要, P2=一般, P3=可选 |
> | `depends_on` | M001,M002 或 `-` | 依赖的模块 ID |
> | `effort` | 数字 | 预估人天（dev+test） |
> | `risk` | 文本或 `-` | 主要风险（可选） |
> | `owner` | @name 或 `-` | 负责人（可选） |

| module_id | feature_name | 模块名称 | scope | deliverable | acceptance | priority | depends_on | effort | risk | owner |
|-----------|--------------|----------|-------|-------------|------------|----------|------------|--------|------|-------|
| M001 | user-auth | 用户认证 | 用户登录、注册、密码重置、Token管理 | API, Tables | 用户可完成注册登录流程 | P0 | - | 5 | 第三方登录集成复杂度 | @{name} |
| M002 | user-profile | 用户资料 | 个人信息查看、编辑、头像上传 | API, UI, Tables | 用户可编辑并保存个人资料 | P1 | M001 | 3 | OSS 配置 | @{name} |
| M003 | {feature} | {名称} | {一句话范围} | {API/UI/Tables/Jobs} | {验收标准} | {P0-P3} | {deps或-} | {N} | {风险或-} | @{name} |

### 2.1 Deliverable 约束生成器

> **重要**：`deliverable` 字段决定该 feature 必须产出哪些文件。
> `/new-feature` 会根据此规则自动生成对应的占位文件。

| Deliverable | 必需产出物 | 说明 |
|-------------|-----------|------|
| **API** | `20_API_SPEC.md` | API 接口规格（端点、请求/响应、错误码） |
| **UI** | `21_UI_FLOW_SPEC.md` + `_demos/` | UI 流程规格 + Demo 页面目录 |
| **Tables** | `30_DB_SCHEMA.md` | 数据库表结构设计 |
| **Jobs** | `25_JOB_SPEC.md` | 后台任务规格（触发条件、输入输出、重试策略） |

**组合示例**：

| deliverable | 自动生成的文件 |
|-------------|---------------|
| `API` | `20_API_SPEC.md` |
| `API, Tables` | `20_API_SPEC.md`, `30_DB_SCHEMA.md` |
| `API, UI, Tables` | `20_API_SPEC.md`, `21_UI_FLOW_SPEC.md`, `30_DB_SCHEMA.md`, `_demos/` |
| `Jobs, Tables` | `25_JOB_SPEC.md`, `30_DB_SCHEMA.md` |

### 2.2 Acceptance 字段规则

> **重要**：`acceptance` 必须是**可验证的结果**，而非「完成开发」。

**正确示例** ✅：
- "用户可在 3 秒内完成登录，错误提示清晰可感知"
- "管理员可导出 CSV 报表，包含过去 30 天数据"
- "系统每日 00:00 自动执行清理，保留最近 90 天数据"

**错误示例** ❌：
- "完成用户登录功能" → 太模糊，无法验证
- "实现 API 接口" → 描述的是过程，不是结果
- "前端页面开发完成" → 无验收标准

### 2.3 模块详情

#### M001: user-auth（用户认证）

**功能范围**：
- 用户注册（邮箱/手机/第三方）
- 用户登录
- 密码重置
- Token 管理

**技术要点**：
- JWT Token 认证
- 密码加密存储
- 登录态管理

**预估工作量**：{N} 人天

---

#### M002: user-profile（用户资料）

**功能范围**：
- 查看个人资料
- 编辑个人信息
- 头像上传
- 账号设置

**技术要点**：
- 文件上传（OSS）
- 表单验证

**预估工作量**：{N} 人天

---

#### M003: {feature_name}

**功能范围**：
- {功能点1}
- {功能点2}

**技术要点**：
- {技术点1}
- {技术点2}

**预估工作量**：{N} 人天

---

## 3. 模块依赖图

### 3.1 依赖关系图

```
模块依赖关系：

                    ┌─────────────┐
                    │   M001      │
                    │  user-auth  │
                    └──────┬──────┘
                           │
              ┌────────────┼────────────┐
              │            │            │
              ▼            ▼            ▼
        ┌──────────┐ ┌──────────┐ ┌──────────┐
        │  M002    │ │  M003    │ │  M004    │
        │ profile  │ │ {name}   │ │ {name}   │
        └──────────┘ └──────────┘ └──────────┘
                           │
                           ▼
                     ┌──────────┐
                     │  M005    │
                     │ {name}   │
                     └──────────┘

图例：
  A ──▶ B  表示 B 依赖 A（A 必须先完成）
```

### 3.2 依赖矩阵

|  | M001 | M002 | M003 | M004 | M005 |
|--|------|------|------|------|------|
| M001 | - | | | | |
| M002 | ✓ | - | | | |
| M003 | ✓ | | - | | |
| M004 | ✓ | | | - | |
| M005 | | | ✓ | | - |

`✓` 表示行模块依赖列模块

### 3.3 开发顺序建议

基于依赖关系，推荐的开发批次：

| 批次 | 模块 | 说明 |
|------|------|------|
| **第一批** | M001 | 无依赖，优先开发 |
| **第二批** | M002, M003, M004 | 依赖第一批 |
| **第三批** | M005 | 依赖第二批 |

---

## 4. 接口边界定义

### 4.1 模块间接口

#### M001 → M002 接口

| 接口 | 方法 | 说明 |
|------|------|------|
| 获取当前用户 | `getCurrentUser()` | 返回当前登录用户信息 |
| 验证 Token | `verifyToken(token)` | 验证 Token 有效性 |

#### M001 → M003 接口

| 接口 | 方法 | 说明 |
|------|------|------|
| {接口名} | `{方法签名}` | {说明} |

### 4.2 外部系统接口

| 外部系统 | 接口类型 | 用途 | 文档 |
|----------|----------|------|------|
| {系统1} | REST API | {用途} | {文档链接} |
| {系统2} | SDK | {用途} | {文档链接} |

---

## 5. 数据模型概览

### 5.1 核心实体关系

```
实体关系图：

┌──────────┐       ┌──────────┐       ┌──────────┐
│   User   │──1:N──│  Order   │──N:M──│ Product  │
└──────────┘       └──────────┘       └──────────┘

{请根据实际业务替换}
```

### 5.2 模块数据边界

| 模块 | 管理的实体 | 只读访问的实体 |
|------|------------|----------------|
| M001 user-auth | User, Token | - |
| M002 user-profile | UserProfile | User |
| M003 {name} | {entities} | {entities} |

---

## 6. 技术约束

### 6.1 统一约定

| 约定 | 说明 |
|------|------|
| API 路径 | `/api/v1/{module}/{resource}` |
| 错误码 | `{MODULE}_{ERROR_TYPE}_{CODE}` |
| 日志格式 | `[{module}] {message}` |

### 6.2 模块间通信

- **同步调用**：HTTP / gRPC
- **异步通信**：消息队列（事件名：`{module}.{action}.{status}`）

---

## CHANGELOG

| 版本 | 日期 | 作者 | 变更内容 |
|------|------|------|----------|
| v0.1 | {date} | {author} | 初始版本 |

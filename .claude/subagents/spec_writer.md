# spec_writer - 生成 SPEC 文档

## 能力描述

根据 `10_CONTEXT.md` 中定义的功能需求，自动生成完整的规格文档：
- `21_UI_FLOW_SPEC.md` - UI 流程规格（前端功能）
- `20_API_SPEC.md` - API 规格（后端功能）

这是一个复杂的工作流，会调用多个 Skills 来完成任务。

## 输入

| 参数 | 类型 | 必需 | 说明 |
|------|------|------|------|
| feature | string | 是 | 功能模块名称 |
| spec_type | string | 否 | 规格类型：`ui`, `api`, `both`，默认根据 CONTEXT 自动判断 |
| detail_level | string | 否 | 详细程度：`basic`, `standard`（默认）, `detailed` |

## 输出

- `docs/{feature}/21_UI_FLOW_SPEC.md` - UI 流程规格
- `docs/{feature}/20_API_SPEC.md` - API 规格（如适用）
- `docs/{feature}/11_SPEC_CHANGELOG.md` - 变更日志

## 工作流程

```
┌─────────────────────────────────────────────────────┐
│                    spec_writer                       │
├─────────────────────────────────────────────────────┤
│                                                      │
│  1. 读取 10_CONTEXT.md                               │
│     ↓                                                │
│  2. 分析功能需求                                     │
│     ├── 提取用户故事                                │
│     ├── 识别功能边界                                │
│     └── 确定规格类型                                │
│     ↓                                                │
│  3. 生成 SPEC 框架                                   │
│     └── 调用 doc_generator skill                    │
│     ↓                                                │
│  4. 填充详细内容                                     │
│     ├── 页面定义                                    │
│     ├── 字段规格                                    │
│     ├── 交互规则                                    │
│     └── 状态定义                                    │
│     ↓                                                │
│  5. 验证 SPEC 完整性                                 │
│     └── 调用 spec_validator skill                   │
│     ↓                                                │
│  6. 创建 CHANGELOG                                   │
│     └── 调用 changelog_updater skill                │
│     ↓                                                │
│  7. 输出结果                                         │
│                                                      │
└─────────────────────────────────────────────────────┘
```

## 调用的 Skills

| Skill | 用途 |
|-------|------|
| `doc_generator` | 生成 SPEC 框架文档 |
| `spec_validator` | 验证 SPEC 完整性 |
| `changelog_updater` | 创建/更新 CHANGELOG |

## 执行步骤

### 1. 读取 CONTEXT

```
读取：docs/{feature}/10_CONTEXT.md
提取：
- 功能概述
- 用户故事
- 功能边界
- 约束条件
```

### 2. 分析并确定规格类型

```yaml
# 自动判断规则
spec_type_rules:
  ui:
    - CONTEXT 中包含"页面"、"表单"、"按钮"等 UI 关键词
    - 用户故事涉及界面交互
  api:
    - CONTEXT 中包含"接口"、"API"、"服务"等关键词
    - 功能主要是数据处理
  both:
    - 同时满足上述条件
```

### 3. 生成 UI_FLOW_SPEC

调用 `doc_generator` skill 生成框架后，填充以下内容：

```markdown
# {Feature} - UI 流程规格

> 版本：v1.0
> 创建日期：{date}
> 来源：10_CONTEXT.md

---

## 页面清单

| 页面 | 路由 | 说明 |
|------|------|------|
| LoginPage | /login | 用户登录 |
| RegisterPage | /register | 用户注册 |

---

## 页面详情

### LoginPage - 用户登录

**路由**：`/login`
**权限**：无需登录

#### 页面结构

```
┌─────────────────────────────────────┐
│             Logo                     │
├─────────────────────────────────────┤
│  ┌─────────────────────────────┐   │
│  │  邮箱                        │   │
│  └─────────────────────────────┘   │
│  ┌─────────────────────────────┐   │
│  │  密码                 [显示] │   │
│  └─────────────────────────────┘   │
│  ☐ 记住我                          │
│  ┌─────────────────────────────┐   │
│  │         登 录                │   │
│  └─────────────────────────────┘   │
│  忘记密码？ | 注册新账号            │
└─────────────────────────────────────┘
```

#### 字段定义

| 字段 | 类型 | 必填 | 验证规则 | 说明 |
|------|------|------|----------|------|
| email | input | 是 | required, email | 用户邮箱 |
| password | password | 是 | required, min:8 | 用户密码 |
| remember | checkbox | 否 | - | 记住登录状态 |

#### 交互规则

| 操作 | 触发条件 | 行为 |
|------|---------|------|
| 点击登录 | 表单验证通过 | 调用登录 API，成功跳转首页 |
| 点击忘记密码 | - | 跳转到 /forgot-password |
| 点击注册 | - | 跳转到 /register |

#### 状态定义

| 状态 | 触发条件 | UI 表现 |
|------|---------|--------|
| initial | 页面加载 | 空表单，按钮可用 |
| loading | 提交中 | 按钮禁用，显示加载 |
| error | 登录失败 | 显示错误提示 |
| success | 登录成功 | 跳转到首页 |

---

## 公共组件

### FormInput

通用表单输入组件

**Props**：
| 属性 | 类型 | 默认值 | 说明 |
|------|------|--------|------|
| type | string | 'text' | 输入类型 |
| label | string | - | 标签文字 |
| placeholder | string | - | 占位文字 |
| rules | array | [] | 验证规则 |

---

## 错误处理

| 错误场景 | 错误码 | 提示文案 |
|---------|--------|---------|
| 邮箱格式错误 | VALIDATION | 请输入有效的邮箱地址 |
| 密码太短 | VALIDATION | 密码至少 8 个字符 |
| 账号不存在 | 401 | 账号或密码错误 |
| 密码错误 | 401 | 账号或密码错误 |

---

_Generated by spec_writer | {datetime}_
```

### 4. 验证 SPEC

调用 `spec_validator` skill 检查：
- 所有用户故事是否有对应的页面/API
- 字段定义是否完整
- 交互规则是否明确
- 状态覆盖是否完整

### 5. 创建 CHANGELOG

调用 `changelog_updater` skill：
```
- doc_type: spec
- change_type: added
- description: 初始版本，包含登录、注册页面规格
```

### 6. 输出结果

```
✅ SPEC 文档生成成功

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
📄 生成的文档
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
• docs/{feature}/21_UI_FLOW_SPEC.md
• docs/{feature}/11_SPEC_CHANGELOG.md

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
📋 SPEC 摘要
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
规格类型：UI Flow
页面数量：4
组件数量：2
用户故事覆盖率：100%

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
✓ 验证结果
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
• 完整性检查：通过
• 一致性检查：通过
• 无遗漏警告

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

💡 下一步：
1. 人工评审 SPEC 内容
2. 使用 /gen-demo 生成 Demo 验证
3. 评审通过后进入 Phase 4 Design
```

## 示例

### 示例输入

```
请使用 spec_writer subagent：
- feature: user-auth
- spec_type: ui
- detail_level: detailed
```

### 示例输出

生成详细的 UI 流程规格文档，包含所有页面、字段、交互、状态的完整定义。

## 注意事项

1. **CONTEXT 依赖**：必须先有完整的 10_CONTEXT.md
2. **用户故事覆盖**：确保每个用户故事都有对应的页面/API
3. **人工评审**：生成的 SPEC 需要人工评审确认
4. **迭代修改**：根据评审意见可以重新生成或手动修改

## 关联工具

- `/new-feature` - 创建功能后可调用此 subagent
- `spec_validator` - 验证 SPEC 完整性
- `ui_demo` - 根据 SPEC 生成 Demo

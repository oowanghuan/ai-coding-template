# test_report_generator - 生成测试报告

## 能力描述

汇总测试执行结果，生成 `61_TEST_REPORT.md` 测试报告，包括测试概览、详细结果、问题分析和改进建议。

## 输入

| 参数 | 类型 | 必需 | 说明 |
|------|------|------|------|
| feature | string | 是 | 功能模块名称 |
| test_results | object | 否 | 测试结果数据，不提供则读取最近一次执行结果 |
| include_screenshots | boolean | 否 | 是否包含截图，默认 true |

## 输出

- `docs/{feature}/61_TEST_REPORT.md` - 测试报告

## 执行步骤

### 1. 收集测试数据

```yaml
# 从 test_runner 获取或读取缓存的结果
test_data:
  execution_time: "2024-12-11T16:30:00+08:00"
  duration: "45.2s"
  results:
    ui_tests: { passed: 8, failed: 1, total: 9 }
    api_tests: { passed: 4, failed: 1, total: 5 }
    unit_tests: { passed: 10, failed: 0, total: 10 }
```

### 2. 分析测试覆盖

```yaml
coverage_analysis:
  # 用例覆盖
  user_stories:
    - id: US-001
      tests: [TC-UI-001, TC-UI-002, TC-API-001]
      status: partial  # all/partial/none

  # 功能覆盖
  features:
    登录: { covered: true, tests: 3 }
    注册: { covered: true, tests: 2 }
    密码重置: { covered: false, tests: 0 }
```

### 3. 生成报告

```markdown
# 测试报告 - {feature}

> 功能模块：{feature}
> 测试时间：{datetime}
> 报告版本：{version}

---

## 执行摘要

| 指标 | 数值 |
|------|------|
| 总测试用例 | 24 |
| 通过 | 22 |
| 失败 | 2 |
| 通过率 | 91.7% |
| 执行耗时 | 45.2s |

### 结论

✅ **测试基本通过**

主要功能验证通过，有 2 个次要问题需要修复。

---

## 测试结果详情

### UI 测试 (9/9 通过)

| ID | 名称 | 状态 | 耗时 |
|----|------|------|------|
| TC-UI-001 | 登录成功 | ✅ | 2.3s |
| TC-UI-002 | 登录失败-密码错误 | ✅ | 1.8s |
| TC-UI-003 | 登录失败-账号不存在 | ✅ | 1.5s |
| ... | ... | ... | ... |

### API 测试 (4/5 通过)

| ID | 名称 | 状态 | 耗时 |
|----|------|------|------|
| TC-API-001 | POST /login 成功 | ✅ | 0.3s |
| TC-API-002 | POST /login 失败 | ✅ | 0.2s |
| TC-API-003 | POST /register 邮箱重复 | ❌ | 0.4s |
| ... | ... | ... | ... |

### 单元测试 (10/10 通过)

| ID | 名称 | 状态 | 耗时 |
|----|------|------|------|
| TC-UNIT-001 | validateEmail() | ✅ | 0.01s |
| ... | ... | ... | ... |

---

## 失败用例分析

### 失败用例记录模板

每个失败用例按以下格式记录：

```markdown
### {TC-ID}: {测试用例名称}

| 字段 | 内容 |
|------|------|
| 状态 | ❌ FAIL → {✅ FIXED / ⏳ PENDING} |
| 级别 | {P0/P1/P2/P3} |
| 发现时间 | {datetime} |
| 修复时间 | {datetime / -} |

**问题描述**：
{简要描述问题现象}

**复现步骤**：
1. {step 1}
2. {step 2}
3. ...

**预期结果**：
{expected}

**实际结果**：
{actual}

**Console/日志**：
```
{error logs}
```

**根因分析**：
{root cause}

**修复方案**：
{fix suggestion}

**修复 Commit**：
`{fix commit message} #{commit_hash}`

**回归测试**：
{✅ 通过 / ❌ 失败 / ⏳ 待测}
```

### 示例：TC-API-003: POST /register 邮箱重复

| 字段 | 内容 |
|------|------|
| 状态 | ❌ FAIL → ✅ FIXED |
| 级别 | P1 |
| 发现时间 | 2024-12-16 10:30 |
| 修复时间 | 2024-12-16 11:15 |

**问题描述**：
注册接口在邮箱已存在时返回 500 而非 409。

**复现步骤**：
1. 使用已存在的邮箱调用 POST /api/auth/register
2. 观察返回状态码

**预期结果**：
- 状态码：409
- 响应：`{ "code": 409, "message": "邮箱已被注册" }`

**实际结果**：
- 状态码：500
- 响应：`{ "code": 500, "message": "Internal Server Error" }`

**Console/日志**：
```
[ERROR] Unhandled exception: UniqueConstraintViolation
```

**根因分析**：
后端未正确捕获数据库唯一约束异常。

**修复方案**：
检查 `auth.controller.ts` 的注册逻辑，添加邮箱重复检查。

**修复 Commit**：
`fix(auth): 处理邮箱重复注册返回正确错误码 #a1b2c3d`

**回归测试**：
✅ 通过

---

## 测试覆盖分析

### 用户故事覆盖

| 用户故事 | 测试用例 | 覆盖状态 |
|---------|---------|---------|
| US-001 登录 | TC-UI-001~003, TC-API-001~002 | ✅ 完全覆盖 |
| US-002 注册 | TC-UI-004~006, TC-API-003~004 | ✅ 完全覆盖 |
| US-003 密码重置 | - | ❌ 未覆盖 |

### 功能覆盖

```
登录功能        ████████████████████ 100%
注册功能        ████████████████████ 100%
密码重置        ░░░░░░░░░░░░░░░░░░░░   0%
```

### 覆盖率建议

- 需要为 US-003 密码重置 添加测试用例
- 建议测试用例数：5（UI: 3, API: 2）

---

## 问题汇总

### 按严重程度

| 级别 | 数量 | 描述 |
|------|------|------|
| P0 (阻塞) | 0 | - |
| P1 (严重) | 1 | 注册邮箱重复返回 500 |
| P2 (一般) | 1 | 错误提示显示延迟 |
| P3 (轻微) | 0 | - |

### 修复优先级

1. **[P1] TC-API-003** - 注册邮箱重复错误处理
2. **[P2] TC-UI-005** - 错误提示显示优化

---

## 测试环境

| 项目 | 配置 |
|------|------|
| 操作系统 | macOS 14.0 |
| 浏览器 | Chrome 120 |
| Node.js | 18.17.0 |
| 前端服务 | localhost:3000 |
| API 服务 | localhost:8080 |

---

## 附件

### 截图

- [TC-UI-001 登录成功](./screenshots/TC-UI-001.png)
- [TC-API-003 失败响应](./screenshots/TC-API-003.png)

### 日志

- [完整测试日志](./logs/test-2024-12-11.log)

---

_Generated by test_report_generator | {datetime}_
```

## 示例

### 示例输入

```
请使用 test_report_generator skill：
- feature: user-auth
- include_screenshots: true
```

### 示例输出

生成完整的测试报告，包含截图链接。

## 注意事项

1. **数据来源**：优先使用 `test_results` 参数，否则读取最近执行结果
2. **截图管理**：截图保存在 `docs/{feature}/screenshots/` 目录
3. **覆盖分析**：需要读取 `10_CONTEXT.md` 中的用户故事进行对照
4. **历史比较**：可选与上次报告对比，显示趋势

## 关联工具

- `test_runner` - 执行测试，产出结果数据
- `/run-tests` - 执行测试并自动生成报告
- `release_summarizer` - 汇总测试报告到发布说明
